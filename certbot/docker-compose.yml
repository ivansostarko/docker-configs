services:
  # ------------------------
  # Nginx (serves ACME HTTP-01 + your TLS vhost)
  # ------------------------
  nginx:
    image: nginx:1.27-alpine
    container_name: nginx
    hostname: nginx
    restart: unless-stopped
    ports:
      - "${HTTP_PORT:-80}:80"
      - "${HTTPS_PORT:-443}:443"
    environment:
      - TZ=${TZ}
    volumes:
      - certbot_webroot:/var/www/certbot:ro
      - letsencrypt:/etc/letsencrypt:ro
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - nginx_logs:/var/log/nginx
    networks:
      - edge
      - observability
    # Practical operational choice:
    # certbot renew updates files; nginx must reload to pick up renewed certs.
    command: >
      /bin/sh -c '
        while :; do
          sleep ${NGINX_RELOAD_INTERVAL_SECONDS:-21600} & wait $${!};
          nginx -s reload || true;
        done &
        nginx -g "daemon off;"'
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1/healthz | grep -q ok"]
      interval: 30s
      timeout: 5s
      retries: 5

  # ------------------------
  # One-shot issuance (run manually)
  # ------------------------
  certbot-init:
    image: certbot/certbot:latest
    container_name: certbot-init
    profiles: ["init", "webroot"]
    depends_on:
      nginx:
        condition: service_healthy
    environment:
      - TZ=${TZ}
      - PRIMARY_DOMAIN=${PRIMARY_DOMAIN}
      - DOMAINS=${DOMAINS}
      - CERTBOT_RSA_KEY_SIZE=${CERTBOT_RSA_KEY_SIZE:-4096}
      - LE_STAGING=${LE_STAGING:-0}
    secrets:
      - le_email
    volumes:
      - certbot_webroot:/var/www/certbot
      - letsencrypt:/etc/letsencrypt
      - ./scripts/certbot-init.sh:/opt/certbot-init.sh:ro
    networks:
      - edge
    entrypoint: ["/bin/sh", "/opt/certbot-init.sh"]
    restart: "no"

  # ------------------------
  # Renewal loop (runs continuously)
  # ------------------------
  certbot-renew:
    image: certbot/certbot:latest
    container_name: certbot-renew
    profiles: ["webroot"]
    restart: unless-stopped
    environment:
      - TZ=${TZ}
      - PRIMARY_DOMAIN=${PRIMARY_DOMAIN}
      - CERTBOT_RENEW_INTERVAL_SECONDS=${CERTBOT_RENEW_INTERVAL_SECONDS:-43200} # 12h
      - LE_STAGING=${LE_STAGING:-0}
    volumes:
      - certbot_webroot:/var/www/certbot
      - letsencrypt:/etc/letsencrypt
      - ./scripts/certbot-renew.sh:/opt/certbot-renew.sh:ro
    networks:
      - edge
    entrypoint: ["/bin/sh", "/opt/certbot-renew.sh"]
    healthcheck:
      test: ["CMD-SHELL", "test -d /etc/letsencrypt/live/${PRIMARY_DOMAIN}"]
      interval: 1m
      timeout: 5s
      retries: 10

  # ------------------------
  # Optional: certificate expiry metrics (Prometheus)
  # ------------------------
  cert_exporter:
    image: joeelliott/cert-exporter:latest
    container_name: cert-exporter
    profiles: ["metrics"]
    restart: unless-stopped
    command:
      - "-listen=:9219"
      - "-path=/etc/letsencrypt"
    volumes:
      - letsencrypt:/etc/letsencrypt:ro
    networks:
      - observability
    ports:
      - "${CERT_EXPORTER_PORT:-9219}:9219"
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:9219/metrics | grep -q cert_"]
      interval: 30s
      timeout: 5s
      retries: 5

  # ------------------------
  # Optional: Nginx metrics (Prometheus)
  # ------------------------
  nginx_exporter:
    image: nginx/nginx-prometheus-exporter:latest
    container_name: nginx-exporter
    profiles: ["metrics"]
    restart: unless-stopped
    command:
      - "-nginx.scrape-uri=http://nginx:80/stub_status"
    depends_on:
      nginx:
        condition: service_healthy
    networks:
      - observability
    ports:
      - "${NGINX_EXPORTER_PORT:-9113}:9113"
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:9113/metrics | grep -q nginx_"]
      interval: 30s
      timeout: 5s
      retries: 5

  # ------------------------
  # Optional: Prometheus (scrape exporters)
  # ------------------------
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    profiles: ["metrics"]
    restart: unless-stopped
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    networks:
      - observability
    ports:
      - "${PROMETHEUS_PORT:-9090}:9090"
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:9090/-/healthy | grep -q Prometheus"]
      interval: 30s
      timeout: 5s
      retries: 5

networks:
  edge:
    driver: bridge
  observability:
    driver: bridge
    internal: true

volumes:
  letsencrypt:
  certbot_webroot:
  nginx_logs:
  prometheus_data:

secrets:
  le_email:
    file: ./secrets/le_email.txt
  # Optional (DNS-01): reserved for future extension
  cf_api_token:
    file: ./secrets/cf_api_token.txt
