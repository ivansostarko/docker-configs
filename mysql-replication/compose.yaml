name: ${COMPOSE_PROJECT_NAME:-mysql-repl}

services:
  mysql-primary:
    image: mysql:${MYSQL_VERSION:-8.4}
    container_name: ${COMPOSE_PROJECT_NAME:-mysql-repl}-mysql-primary
    restart: unless-stopped
    command:
      - mysqld
      - --defaults-file=/etc/mysql/my.cnf
      - --defaults-extra-file=/etc/mysql/conf.d/primary.cnf
    environment:
      TZ: ${TZ:-Europe/Zagreb}

      # Initialization
      MYSQL_DATABASE: ${MYSQL_DATABASE:-appdb}
      MYSQL_USER: ${MYSQL_APP_USER:-app}
      MYSQL_PASSWORD_FILE: /run/secrets/mysql_app_password
      MYSQL_ROOT_PASSWORD_FILE: /run/secrets/mysql_root_password

      # Tunables
      MYSQL_INITDB_SKIP_TZINFO: "1"
    secrets:
      - mysql_root_password
      - mysql_app_password
      - mysql_repl_password
      - mysql_exporter_password
    configs:
      - source: mysql_base_cnf
        target: /etc/mysql/my.cnf
        mode: 0444
      - source: mysql_primary_cnf
        target: /etc/mysql/conf.d/primary.cnf
        mode: 0444
      - source: primary_init_sh
        target: /docker-entrypoint-initdb.d/01-primary-init.sh
        mode: 0555
    volumes:
      - mysql_primary_data:/var/lib/mysql
    networks:
      - db_net
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h 127.0.0.1 -uroot --password="$(cat /run/secrets/mysql_root_password)" --silent"]
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 30s

    # Optional: publish port for applications on the Docker host
    ports:
      - "${MYSQL_PRIMARY_PORT:-3306}:3306"

  mysql-replica1:
    image: mysql:${MYSQL_VERSION:-8.4}
    container_name: ${COMPOSE_PROJECT_NAME:-mysql-repl}-mysql-replica1
    restart: unless-stopped
    command:
      - mysqld
      - --defaults-file=/etc/mysql/my.cnf
      - --defaults-extra-file=/etc/mysql/conf.d/replica.cnf
    environment:
      TZ: ${TZ:-Europe/Zagreb}
      MYSQL_ROOT_PASSWORD_FILE: /run/secrets/mysql_root_password
      MYSQL_DATABASE: ${MYSQL_DATABASE:-appdb}
      MYSQL_USER: ${MYSQL_APP_USER:-app}
      MYSQL_PASSWORD_FILE: /run/secrets/mysql_app_password
      MYSQL_INITDB_SKIP_TZINFO: "1"
    secrets:
      - mysql_root_password
      - mysql_app_password
    configs:
      - source: mysql_base_cnf
        target: /etc/mysql/my.cnf
        mode: 0444
      - source: mysql_replica_cnf
        target: /etc/mysql/conf.d/replica.cnf
        mode: 0444
    volumes:
      - mysql_replica1_data:/var/lib/mysql
    networks:
      - db_net
    depends_on:
      mysql-primary:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h 127.0.0.1 -uroot --password="$(cat /run/secrets/mysql_root_password)" --silent"]
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 45s

    # Optional: publish port for troubleshooting from the Docker host
    ports:
      - "${MYSQL_REPLICA1_PORT:-3307}:3306"

  replica1-configurer:
    image: mysql:${MYSQL_VERSION:-8.4}
    container_name: ${COMPOSE_PROJECT_NAME:-mysql-repl}-replica1-configurer
    restart: "no"
    entrypoint: ["/bin/bash", "/scripts/configure-replication.sh"]
    environment:
      PRIMARY_HOST: mysql-primary
      REPLICA_HOST: mysql-replica1
      REPL_USER: ${MYSQL_REPL_USER:-repl}
      ROOT_PASSWORD_FILE: /run/secrets/mysql_root_password
      REPL_PASSWORD_FILE: /run/secrets/mysql_repl_password
      CONNECT_RETRIES: "60"
      CONNECT_SLEEP_SECS: "2"
    secrets:
      - mysql_root_password
      - mysql_repl_password
    configs:
      - source: configure_replication_sh
        target: /scripts/configure-replication.sh
        mode: 0555
    networks:
      - db_net
    depends_on:
      mysql-primary:
        condition: service_healthy
      mysql-replica1:
        condition: service_healthy

  # Metrics: per-instance MySQL exporter
  mysqld-exporter-primary:
    image: prom/mysqld-exporter:${MYSQLD_EXPORTER_VERSION:-v0.16.0}
    container_name: ${COMPOSE_PROJECT_NAME:-mysql-repl}-mysqld-exporter-primary
    restart: unless-stopped
    command:
      - "--web.listen-address=:9104"
      - "--collect.global_status"
      - "--collect.global_variables"
      - "--collect.info_schema.innodb_metrics"
      - "--collect.info_schema.processlist"
      - "--collect.info_schema.tables"
      - "--collect.slave_status"
      - "--collect.perf_schema.tableiowaits"
      - "--collect.perf_schema.indexiowaits"
      - "--collect.perf_schema.tablelocks"
      - "--collect.perf_schema.eventsstatements"
      - "--collect.perf_schema.eventsstatementssum"
      - "--collect.auto_increment.columns"
    environment:
      # DSN is read from a Docker secret by the shell wrapper
      # Example DSN: exporter:password@(mysql-primary:3306)/
      DATA_SOURCE_NAME: "unused"
    secrets:
      - mysql_exporter_primary_dsn
    entrypoint:
      - /bin/sh
      - -ec
      - |
        export DATA_SOURCE_NAME="$(cat /run/secrets/mysql_exporter_primary_dsn)"
        exec /bin/mysqld_exporter "$@"
    networks:
      - monitoring_net
      - db_net
    depends_on:
      mysql-primary:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:9104/metrics >/dev/null 2>&1"]
      interval: 15s
      timeout: 5s
      retries: 10
      start_period: 20s

  mysqld-exporter-replica1:
    image: prom/mysqld-exporter:${MYSQLD_EXPORTER_VERSION:-v0.16.0}
    container_name: ${COMPOSE_PROJECT_NAME:-mysql-repl}-mysqld-exporter-replica1
    restart: unless-stopped
    command:
      - "--web.listen-address=:9104"
      - "--collect.global_status"
      - "--collect.global_variables"
      - "--collect.info_schema.innodb_metrics"
      - "--collect.info_schema.processlist"
      - "--collect.info_schema.tables"
      - "--collect.slave_status"
      - "--collect.perf_schema.tableiowaits"
      - "--collect.perf_schema.indexiowaits"
      - "--collect.perf_schema.tablelocks"
      - "--collect.perf_schema.eventsstatements"
      - "--collect.perf_schema.eventsstatementssum"
      - "--collect.auto_increment.columns"
    environment:
      DATA_SOURCE_NAME: "unused"
    secrets:
      - mysql_exporter_replica1_dsn
    entrypoint:
      - /bin/sh
      - -ec
      - |
        export DATA_SOURCE_NAME="$(cat /run/secrets/mysql_exporter_replica1_dsn)"
        exec /bin/mysqld_exporter "$@"
    networks:
      - monitoring_net
      - db_net
    depends_on:
      mysql-replica1:
        condition: service_healthy
      replica1-configurer:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:9104/metrics >/dev/null 2>&1"]
      interval: 15s
      timeout: 5s
      retries: 10
      start_period: 20s

  prometheus:
    image: prom/prometheus:${PROMETHEUS_VERSION:-v2.55.0}
    container_name: ${COMPOSE_PROJECT_NAME:-mysql-repl}-prometheus
    restart: unless-stopped
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--web.enable-lifecycle"
    configs:
      - source: prometheus_yml
        target: /etc/prometheus/prometheus.yml
        mode: 0444
    volumes:
      - prometheus_data:/prometheus
    ports:
      - "${PROMETHEUS_PORT:-9090}:9090"
    networks:
      - monitoring_net
    depends_on:
      mysqld-exporter-primary:
        condition: service_healthy
      mysqld-exporter-replica1:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:9090/-/ready >/dev/null 2>&1"]
      interval: 15s
      timeout: 5s
      retries: 10
      start_period: 20s

  grafana:
    image: grafana/grafana-oss:${GRAFANA_VERSION:-11.2.0}
    container_name: ${COMPOSE_PROJECT_NAME:-mysql-repl}-grafana
    restart: unless-stopped
    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_ADMIN_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD_FILE: /run/secrets/grafana_admin_password
      GF_USERS_ALLOW_SIGN_UP: "false"
      GF_AUTH_ANONYMOUS_ENABLED: "false"
      GF_SERVER_ROOT_URL: ${GRAFANA_ROOT_URL:-http://localhost:${GRAFANA_PORT:-3000}}
    secrets:
      - grafana_admin_password
    volumes:
      - grafana_data:/var/lib/grafana
    ports:
      - "${GRAFANA_PORT:-3000}:3000"
    networks:
      - monitoring_net
    depends_on:
      prometheus:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:3000/api/health >/dev/null 2>&1"]
      interval: 15s
      timeout: 5s
      retries: 10
      start_period: 30s

networks:
  db_net:
    name: ${COMPOSE_PROJECT_NAME:-mysql-repl}-db
    driver: bridge
    internal: true
  monitoring_net:
    name: ${COMPOSE_PROJECT_NAME:-mysql-repl}-monitoring
    driver: bridge

volumes:
  mysql_primary_data:
    name: ${COMPOSE_PROJECT_NAME:-mysql-repl}-mysql-primary-data
  mysql_replica1_data:
    name: ${COMPOSE_PROJECT_NAME:-mysql-repl}-mysql-replica1-data
  prometheus_data:
    name: ${COMPOSE_PROJECT_NAME:-mysql-repl}-prometheus-data
  grafana_data:
    name: ${COMPOSE_PROJECT_NAME:-mysql-repl}-grafana-data

configs:
  mysql_base_cnf:
    file: ./config/mysql/my.cnf
  mysql_primary_cnf:
    file: ./config/mysql/primary.cnf
  mysql_replica_cnf:
    file: ./config/mysql/replica.cnf
  primary_init_sh:
    file: ./initdb/primary/01-primary-init.sh
  configure_replication_sh:
    file: ./scripts/configure-replication.sh
  prometheus_yml:
    file: ./monitoring/prometheus/prometheus.yml

secrets:
  mysql_root_password:
    file: ./secrets/mysql_root_password.txt
  mysql_app_password:
    file: ./secrets/mysql_app_password.txt
  mysql_repl_password:
    file: ./secrets/mysql_repl_password.txt
  mysql_exporter_password:
    file: ./secrets/mysql_exporter_password.txt
  mysql_exporter_primary_dsn:
    file: ./secrets/mysql_exporter_primary_dsn.txt
  mysql_exporter_replica1_dsn:
    file: ./secrets/mysql_exporter_replica1_dsn.txt
  grafana_admin_password:
    file: ./secrets/grafana_admin_password.txt
