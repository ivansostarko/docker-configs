server {
  listen 80;
  server_name _;

  # Health endpoint for container healthcheck
  location = /healthz {
    add_header Content-Type text/plain;
    return 200 "ok\n";
  }

  # Serve the repo at /fdroid/repo/
  location /fdroid/repo/ {
    alias /var/www/fdroid/repo/;
    autoindex off;

    add_header X-Content-Type-Options nosniff always;
    add_header X-Frame-Options DENY always;

    # Cache static artifacts (clients validate via index/signatures)
    location ~* \.(apk|jar|json|xml|yml|yaml|png|jpg|jpeg|webp|svg)$ {
      expires 7d;
      add_header Cache-Control "public, max-age=604800, immutable";
      try_files $uri =404;
    }

    try_files $uri $uri/ =404;
  }

  # Convenience redirect
  location / {
    return 302 /fdroid/repo/;
  }
}

# Internal-only listener for stub_status (used by metrics profile)
server {
  listen 8080;
  server_name _;

  location = /stub_status {
    stub_status;
    access_log off;

    # Allow only private ranges; docker internal network should match one of these.
    allow 10.0.0.0/8;
    allow 172.16.0.0/12;
    allow 192.168.0.0/16;
    deny all;
  }
}
