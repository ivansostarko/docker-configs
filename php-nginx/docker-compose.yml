name: php-nginx

x-logging: &default-logging
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "5"

x-security: &default-security
  security_opt:
    - no-new-privileges:true
  cap_drop:
    - ALL

networks:
  edge:
    driver: bridge
  backend:
    driver: bridge
    internal: true
  monitoring:
    driver: bridge
    internal: true

volumes:
  php_sessions:
  php_tmp:
  nginx_cache:

secrets:
  app_key:
    file: ./secrets/app_key.txt
  db_password:
    file: ./secrets/db_password.txt

configs:
  nginx_main_conf:
    file: ./nginx/nginx.conf
  nginx_app_conf:
    file: ./nginx/conf.d/app.conf
  nginx_security_headers:
    file: ./nginx/snippets/security-headers.conf
  php_ini:
    file: ./php/php.ini
  php_fpm_pool:
    file: ./php/www.conf
  php_healthcheck:
    file: ./php/healthcheck.sh

services:
  php:
    build:
      context: ./php
      dockerfile: Dockerfile
    container_name: php-fpm
    restart: unless-stopped
    environment:
      APP_ENV: ${APP_ENV:-production}
      APP_DEBUG: ${APP_DEBUG:-0}
      DB_HOST: ${DB_HOST:-db}
      DB_PORT: ${DB_PORT:-5432}
      DB_NAME: ${DB_NAME:-app}
      DB_USER: ${DB_USER:-app}
      DB_PASSWORD_FILE: /run/secrets/db_password
      APP_KEY_FILE: /run/secrets/app_key
      TRUSTED_PROXIES: ${TRUSTED_PROXIES:-}
      TRUSTED_HOSTS: ${TRUSTED_HOSTS:-}
    secrets:
      - app_key
      - db_password
    networks:
      - backend
      - monitoring
    volumes:
      # For production, bake application code into an image.
      - ./app:/var/www/html:rw
      - php_sessions:/var/lib/php/sessions
      - php_tmp:/tmp
    configs:
      - source: php_ini
        target: /usr/local/etc/php/conf.d/zz-app.ini
      - source: php_fpm_pool
        target: /usr/local/etc/php-fpm.d/www.conf
      - source: php_healthcheck
        target: /usr/local/bin/healthcheck.sh
        mode: 0555
    healthcheck:
      test: ["CMD", "/usr/local/bin/healthcheck.sh"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 20s
    <<: *default-security
    logging: *default-logging
    read_only: true
    tmpfs:
      - /run

  nginx:
    image: nginx:1.27-alpine
    container_name: nginx
    restart: unless-stopped
    depends_on:
      php:
        condition: service_healthy
    environment:
      NGINX_SERVER_NAME: ${NGINX_SERVER_NAME:-localhost}
      NGINX_PUBLIC_ROOT: ${NGINX_PUBLIC_ROOT:-/var/www/html/public}
      CLIENT_MAX_BODY_SIZE: ${CLIENT_MAX_BODY_SIZE:-20m}
    networks:
      - edge
      - backend
      - monitoring
    ports:
      - "${HTTP_PORT:-8080}:80"
    volumes:
      - ./app:/var/www/html:ro
      - nginx_cache:/var/cache/nginx
    configs:
      - source: nginx_main_conf
        target: /etc/nginx/nginx.conf
      - source: nginx_app_conf
        target: /etc/nginx/conf.d/default.conf
      - source: nginx_security_headers
        target: /etc/nginx/snippets/security-headers.conf
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1/healthz >/dev/null 2>&1 || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 10s
    <<: *default-security
    logging: *default-logging
    read_only: true
    tmpfs:
      - /run
      - /tmp

  # =========================
  # Metrics (optional)
  # Enable with: docker compose --profile metrics up -d
  # =========================
  nginx_exporter:
    image: nginx/nginx-prometheus-exporter:1.3.0
    container_name: nginx-exporter
    restart: unless-stopped
    profiles: ["metrics"]
    depends_on:
      nginx:
        condition: service_healthy
    command:
      - "-nginx.scrape-uri=http://nginx:80/stub_status"
    networks:
      - monitoring
    ports:
      - "${NGINX_EXPORTER_PORT:-9113}:9113"
    <<: *default-security
    logging: *default-logging
    read_only: true

  php_fpm_exporter:
    image: hipages/php-fpm_exporter:2.2.0
    container_name: php-fpm-exporter
    restart: unless-stopped
    profiles: ["metrics"]
    depends_on:
      php:
        condition: service_healthy
    environment:
      PHP_FPM_SCRAPE_URI: "tcp://php:9000/status"
      PHP_FPM_FIX_PROCESS_COUNT: "true"
    networks:
      - monitoring
    ports:
      - "${PHP_FPM_EXPORTER_PORT:-9253}:9253"
    <<: *default-security
    logging: *default-logging
    read_only: true
