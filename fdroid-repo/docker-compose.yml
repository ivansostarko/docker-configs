name: fdroid-repo

services:
  # Generates/updates F-Droid repo indexes (binary-repo mode: you provide APKs).
  # NOTE: This is not a hardened "build server" architecture. See README for hardening guidance.
  fdroid:
    image: ${FDROID_IMAGE:-registry.gitlab.com/fdroid/docker-executable-fdroidserver:latest}
    container_name: fdroid
    working_dir: /repo
    environment:
      TZ: ${TZ:-Europe/Zagreb}
      FDROID_CREATE_METADATA: ${FDROID_CREATE_METADATA:-0}   # 1 = fdroid update --create-metadata
      FDROID_GPGSIGN: ${FDROID_GPGSIGN:-0}                   # 1 = fdroid gpgsign after update (optional)
      FDROID_LOG_LEVEL: ${FDROID_LOG_LEVEL:-info}
    volumes:
      # Persistent state for fdroidserver (keystores, cache, config copies, etc.)
      - fdroid_state:/repo
      # The published repo content (APKs + indexes). NGINX serves this.
      - fdroid_repo:/repo/repo
      # Operator-managed config and metadata
      - ./config/config.yml:/repo/config.yml:ro
      - ./config/metadata:/repo/metadata:rw
      - ./scripts:/scripts:ro
    secrets:
      - fdroid_keystore
      - fdroid_keystore_pass
      - fdroid_keypass
      - fdroid_keyalias
      - gpg_private_key
      - gpg_passphrase
    command: ["/bin/bash", "/scripts/update.sh"]
    restart: "no"
    networks:
      - internal
    healthcheck:
      # Sanity check after update: repo index should exist.
      test: ["CMD-SHELL", "test -f /repo/repo/index-v1.jar -o -f /repo/repo/index.jar"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # Serves the generated repo over HTTP. Put behind a reverse proxy for TLS in production.
  web:
    image: nginx:1.27-alpine
    container_name: fdroid-web
    depends_on:
      - fdroid
    ports:
      - "${HTTP_PORT:-8080}:80"
      # Optional HTTPS (terminate TLS in nginx if you mount certs into /etc/nginx/tls and extend config)
      # - "${HTTPS_PORT:-8443}:443"
    volumes:
      - fdroid_repo:/var/www/fdroid/repo:ro
      - ./nginx/conf.d/fdroid.conf:/etc/nginx/conf.d/default.conf:ro
      - nginx_cache:/var/cache/nginx
    networks:
      - internal
      - public
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost/healthz | grep -q ok"]
      interval: 15s
      timeout: 5s
      retries: 6
      start_period: 10s
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # Scheduler (optional): runs fdroid updates periodically by calling Docker.
  # WARNING: mounting the Docker socket is root-equivalent access to the host.
  scheduler:
    image: mcuadros/ofelia:0.3.12
    container_name: fdroid-scheduler
    profiles: ["scheduler"]
    depends_on:
      - fdroid
    command: daemon --docker
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - internal
    environment:
      TZ: ${TZ:-Europe/Zagreb}
    labels:
      ofelia.enabled: "true"
      # Default: run every 6 hours. Adjust as needed.
      ofelia.job-run.fdroid-update.schedule: "@every 6h"
      ofelia.job-run.fdroid-update.container: "fdroid"
    logging:
      driver: json-file
      options:
        max-size: "5m"
        max-file: "2"

  # NGINX metrics exporter (optional) via stub_status.
  nginx-exporter:
    image: nginx/nginx-prometheus-exporter:1.3.0
    container_name: fdroid-nginx-exporter
    profiles: ["metrics"]
    depends_on:
      - web
    command:
      - "-nginx.scrape-uri=http://fdroid-web:8080/stub_status"
    ports:
      - "${NGINX_EXPORTER_PORT:-9113}:9113"
    networks:
      - internal
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:9113/metrics | grep -q nginx"]
      interval: 30s
      timeout: 5s
      retries: 3

  prometheus:
    image: prom/prometheus:v2.55.1
    container_name: fdroid-prometheus
    profiles: ["metrics"]
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
    ports:
      - "${PROMETHEUS_PORT:-9090}:9090"
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    networks:
      - internal
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:9090/-/healthy | grep -q Prometheus"]
      interval: 30s
      timeout: 5s
      retries: 3

networks:
  public:
    driver: bridge
  internal:
    driver: bridge
    internal: true

volumes:
  fdroid_state:
  fdroid_repo:
  nginx_cache:
  prometheus_data:

secrets:
  # These are local-file secrets. Replace with your secret manager in production.
  fdroid_keystore:
    file: ./secrets/keystore.p12
  fdroid_keystore_pass:
    file: ./secrets/keystore.pass
  fdroid_keypass:
    file: ./secrets/keypass.pass
  fdroid_keyalias:
    file: ./secrets/keyalias.txt
  gpg_private_key:
    file: ./secrets/repo-signing.key
  gpg_passphrase:
    file: ./secrets/repo-signing.pass
