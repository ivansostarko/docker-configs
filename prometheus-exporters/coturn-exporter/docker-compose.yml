services:
  coturn_exporter:
    build:
      context: ./coturn_exporter
      dockerfile: Dockerfile
    image: coturn_exporter:local
    container_name: coturn_exporter
    restart: unless-stopped

    # If Prometheus is in the same Docker network, you do NOT need ports at all.
    # If you want host access for debugging, bind to localhost only:
    ports:
      - "127.0.0.1:${COTURN_EXPORTER_PORT:-9524}:9524"

    # Documents that other containers can reach 9524 on the Docker network.
    expose:
      - "9524"

    env_file:
      - .env

    # Docker secret: used to render config at runtime (secret never stored in git).
    secrets:
      - coturn_static_auth_secret

    # Config template (non-secret) is mounted read-only.
    volumes:
      - type: bind
        source: ./coturn_exporter/config.yml.tmpl
        target: /etc/coturn_exporter/config.yml.tmpl
        read_only: true

    # Write the rendered config into tmpfs (RAM), not a layer or bind mount.
    tmpfs:
      - /run:rw,noexec,nosuid,size=16m
      - /tmp:rw,noexec,nosuid,size=16m

    # Run as non-root unless your Dockerfile/app requires otherwise.
    user: "65534:65534"

    # Security hardening.
    read_only: true
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL

    # Healthcheck: validates the metrics endpoint is responding.
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:9524/metrics >/dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 20s

    # Keep logs bounded.
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    networks:
      - monitoring

networks:
  monitoring:
    name: monitoring
    driver: bridge
    # internal: true  # enable if ONLY containers on this network should reach each other

secrets:
  coturn_static_auth_secret:
    file: ./secrets/coturn_static_auth_secret.txt
