version: "3.9"

name: monitoring

networks:
  monitoring:
    name: monitoring
    driver: bridge

secrets:
  cf_api_token:
    file: ./secrets/cf_api_token.txt

services:
  cloudflare_exporter:
    # Wrapper image so we can:
    # - read Docker secret file (/run/secrets/cf_api_token)
    # - run an HTTP healthcheck (wget)
    build:
      context: ./cloudflare-exporter-wrapper
    image: local/cloudflare_exporter:0.2.3-wrapper
    container_name: cloudflare_exporter
    restart: unless-stopped

    env_file:
      - .env

    secrets:
      - cf_api_token

    environment:
      # IMPORTANT:
      # - Do NOT set CF_API_TOKEN in .env when using secrets mode.
      # - The wrapper reads /run/secrets/cf_api_token into CF_API_TOKEN at startup.

      # Optional scoping (comma-separated Zone IDs)
      CF_ZONES: ${CF_ZONES:-}
      CF_EXCLUDE_ZONES: ${CF_EXCLUDE_ZONES:-}

      # Exporter server settings
      LISTEN: ${CF_EXPORTER_LISTEN:-:8080}
      METRICS_PATH: ${CF_EXPORTER_METRICS_PATH:-/metrics}

      # Exporter tuning
      SCRAPE_INTERVAL: ${CF_EXPORTER_SCRAPE_INTERVAL:-60}
      SCRAPE_DELAY: ${CF_EXPORTER_SCRAPE_DELAY:-300}
      CF_TIMEOUT: ${CF_EXPORTER_TIMEOUT:-10s}

      # Misc
      FREE_TIER: ${CF_EXPORTER_FREE_TIER:-false}
      LOG_LEVEL: ${CF_EXPORTER_LOG_LEVEL:-error}
      METRICS_DENYLIST: ${CF_EXPORTER_METRICS_DENYLIST:-}
      ENABLE_PPROF: "false"

    ports:
      - "${CF_EXPORTER_PORT:-8080}:8080"

    networks:
      - monitoring

    # Security hardening
    user: "65532:65532"
    read_only: true
    tmpfs:
      - /tmp:rw,noexec,nosuid,size=64m
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    pids_limit: 200

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:8080/metrics >/dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 20s
