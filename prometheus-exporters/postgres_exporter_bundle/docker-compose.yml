services:
  # =========================
  # PostgreSQL Exporter (Prometheus)
  # =========================
  postgres_exporter:
    image: ${POSTGRES_EXPORTER_IMAGE:-prometheuscommunity/postgres-exporter:latest}
    container_name: postgres_exporter
    hostname: postgres_exporter
    restart: unless-stopped

    # Do NOT expose 9187 publicly unless you must.
    # If you truly need host access, keep it bound to localhost.
    ports:
      - "127.0.0.1:${POSTGRES_EXPORTER_PORT:-9187}:9187"

    # Prefer secrets over putting passwords in env.
    secrets:
      - postgres_exporter_user
      - postgres_exporter_password

    env_file:
      - .env

    environment:
      # Exporter runtime
      - PG_EXPORTER_WEB_LISTEN_ADDRESS=:9187
      - PG_EXPORTER_LOG_LEVEL=${POSTGRES_EXPORTER_LOG_LEVEL:-info}

      # Optional: custom queries (recommended for app-specific metrics)
      - PG_EXPORTER_EXTEND_QUERY_PATH=/etc/postgres_exporter/queries.yml

      # Connection pieces used by entrypoint wrapper to build the DSN
      - POSTGRES_HOST=${POSTGRES_HOST:-postgres}
      - POSTGRES_PORT=${POSTGRES_PORT:-5432}
      - POSTGRES_DATABASE=${POSTGRES_DATABASE:-postgres}
      - POSTGRES_SSLMODE=${POSTGRES_SSLMODE:-disable}

    volumes:
      # Wrapper builds DATA_SOURCE_NAME from secrets securely
      - ./postgres_exporter/entrypoint.sh:/entrypoint.sh:ro
      # Custom queries
      - ./postgres_exporter/queries.yml:/etc/postgres_exporter/queries.yml:ro

    entrypoint: ["/bin/sh", "/entrypoint.sh"]

    networks:
      - monitoring

    # Basic operational hygiene
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    # Hardening (sane defaults for an exporter)
    read_only: true
    tmpfs:
      - /tmp
      - /run
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    pids_limit: 200

    # Healthcheck: validates the /metrics endpoint is reachable.
    # Note: if the exporter image ever lacks wget, switch to the /dev/tcp option shown below.
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:9187/metrics >/dev/null 2>&1 || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 10
      start_period: 20s

    # Alternative healthcheck (no wget dependency):
    # healthcheck:
    #   test: ["CMD-SHELL", "sh -c 'cat < /dev/null > /dev/tcp/127.0.0.1/9187'"]
    #   interval: 15s
    #   timeout: 5s
    #   retries: 10
    #   start_period: 20s

    labels:
      - "app=postgres_exporter"
      - "prometheus.scrape=true"
      - "prometheus.port=9187"
      - "prometheus.path=/metrics"

networks:
  monitoring:
    name: ${MONITORING_NETWORK_NAME:-monitoring}
    driver: bridge
    internal: true

secrets:
  postgres_exporter_user:
    file: ./secrets/postgres_exporter_user.txt
  postgres_exporter_password:
    file: ./secrets/postgres_exporter_password.txt
