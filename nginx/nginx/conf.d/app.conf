# HTTP (redirect to HTTPS) + /healthz endpoint used by Docker healthcheck
server {
  listen 8080;
  server_name ${NGINX_SERVER_NAME:-_};

  location = /healthz {
    access_log off;
    return 200 "ok\n";
    add_header Content-Type text/plain;
  }

  location / {
    return 301 https://$host$request_uri;
  }
}

# HTTPS termination (internal listen 8443, published as host :443 by compose)
server {
  listen 8443 ssl http2;
  server_name ${NGINX_SERVER_NAME:-_};

  ssl_certificate     /run/secrets/tls_crt;
  ssl_certificate_key /run/secrets/tls_key;

  ssl_session_cache shared:SSL:10m;
  ssl_session_timeout 10m;

  add_header X-Content-Type-Options nosniff always;
  add_header X-Frame-Options DENY always;
  add_header Referrer-Policy no-referrer always;

  # Example reverse proxy upstream. Replace with your real service.
  location / {
    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_pass http://your_app:8080;
  }

  # Example: protect /admin/ with Basic Auth (htpasswd secret)
  location /admin/ {
    auth_basic           "Restricted";
    auth_basic_user_file /run/secrets/basic_auth_htpasswd;

    proxy_pass http://your_app:8080;
  }
}
