# NGINX + Prometheus Exporter (Docker Compose)

This package provides a hardened, production-oriented NGINX deployment with:
- Unprivileged NGINX container (reduced attack surface)
- Healthchecks
- Separate **frontend** and **internal monitoring** networks
- Prometheus metrics via `stub_status` + `nginx-prometheus-exporter`
- Docker **secrets** for TLS and Basic Auth

## What you get

- `docker-compose.yml` – NGINX + `nginx-prometheus-exporter`
- `.env` – configuration knobs (ports, network names, monitoring subnet, etc.)
- `nginx/nginx.conf` – base NGINX config
- `nginx/conf.d/status.conf` – `stub_status` endpoint (restricted)
- `nginx/conf.d/app.conf` – `/healthz`, HTTP→HTTPS redirect, HTTPS vhost + proxy example
- `scripts/generate-dev-secrets.sh` – generates **dev-only** TLS + htpasswd

## Quick start (dev)

1) Generate development secrets (self-signed TLS + default htpasswd):

```bash
chmod +x scripts/generate-dev-secrets.sh
./scripts/generate-dev-secrets.sh
```

2) Start:

```bash
docker compose up -d
```

3) Verify:

- Health: `http://localhost/healthz` (should return `ok`)
- Metrics (exporter): `http://localhost:9113/metrics`

> Note: `/stub_status` is intentionally **not** exposed publicly. The exporter reaches it over the internal `monitoring` network.

## Configuration

Edit `.env`:

- `NGINX_HTTP_PORT` / `NGINX_HTTPS_PORT` – host ports
- `NGINX_EXPORTER_PORT` – exporter host port (default 9113)
- `MONITORING_SUBNET` – used to restrict access to `/stub_status` in `status.conf`

If you change `MONITORING_SUBNET`, you **must** update the `allow` line in:
- `nginx/conf.d/status.conf`

## Prometheus scrape config

Add this to Prometheus:

```yaml
scrape_configs:
  - job_name: "nginx"
    static_configs:
      - targets: ["nginx_exporter:9113"]
```

(If Prometheus runs outside Docker, target the host port `NGINX_EXPORTER_PORT` instead.)

## Security and operational notes (read this)

- Do **not** expose `/stub_status` publicly. It leaks operational details and makes your infrastructure easier to map.
- Do **not** run `:latest` in production. Pin versions and upgrade deliberately.
- Replace dev secrets:
  - `secrets/tls.crt` and `secrets/tls.key` with real certificates (LetsEncrypt, internal PKI, etc.)
  - `secrets/basic_auth.htpasswd` with a real htpasswd generated by `htpasswd`

## Common adjustments

### Reverse proxy upstream
In `nginx/conf.d/app.conf`, replace:

```nginx
proxy_pass http://your_app:8080;
```

with your real upstream service name and port on the same Docker network.

### Static file hosting
Mount a directory and serve it directly (example):

- Add to `docker-compose.yml` under `nginx:volumes`:

```yaml
- ./www:/usr/share/nginx/html:ro
```

- Add a `location` block in your vhost.

## Troubleshooting

- `nginx` won’t start: check `docker logs nginx`
- Config validation: `docker exec -it nginx nginx -t`
- Exporter can’t scrape: ensure `status.conf` allowlist matches `MONITORING_SUBNET`
