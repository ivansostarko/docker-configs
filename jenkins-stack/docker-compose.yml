services:
  jenkins:
    build:
      context: ./docker/jenkins
    container_name: jenkins
    restart: unless-stopped

    environment:
      TZ: ${TZ}
      JAVA_OPTS: >-
        -Djenkins.install.runSetupWizard=false
        -Djava.awt.headless=true
      JENKINS_OPTS: >-
        --httpPort=8080
        --prefix=${JENKINS_URL_PREFIX}
      CASC_JENKINS_CONFIG: /var/jenkins_home/casc
      JENKINS_URL: ${JENKINS_URL}

    ports:
      - "${JENKINS_HTTP_PORT:-8080}:8080"
      - "${JENKINS_AGENT_PORT:-50000}:50000"

    volumes:
      - jenkins_home:/var/jenkins_home
      - ./casc:/var/jenkins_home/casc:ro

    secrets:
      - jenkins_admin_user
      - jenkins_admin_password

    networks:
      - edge
      - internal

    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8080${JENKINS_URL_PREFIX}/health || curl -fsS http://localhost:8080${JENKINS_URL_PREFIX}/login || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 120s

    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "5"

  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    profiles: ["monitoring"]
    restart: unless-stopped
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    ports:
      - "${PROMETHEUS_PORT:-9090}:9090"
    networks:
      - internal
    depends_on:
      - jenkins

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    profiles: ["monitoring"]
    restart: unless-stopped
    environment:
      TZ: ${TZ}
      GF_SECURITY_ADMIN_USER: ${GRAFANA_ADMIN_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD:-admin}
    volumes:
      - grafana_data:/var/lib/grafana
      - ./monitoring/grafana/provisioning:/etc/grafana/provisioning:ro
    ports:
      - "${GRAFANA_PORT:-3000}:3000"
    networks:
      - internal
    depends_on:
      - prometheus

  dind:
    image: docker:27-dind
    container_name: jenkins-dind
    profiles: ["dind"]
    privileged: true
    restart: unless-stopped
    environment:
      DOCKER_TLS_CERTDIR: /certs
    volumes:
      - dind_certs:/certs
      - dind_data:/var/lib/docker
    networks:
      - internal

volumes:
  jenkins_home:
  prometheus_data:
  grafana_data:
  dind_certs:
  dind_data:

secrets:
  jenkins_admin_user:
    file: ./secrets/jenkins_admin_user.txt
  jenkins_admin_password:
    file: ./secrets/jenkins_admin_password.txt

networks:
  edge:
    name: jenkins_edge
  internal:
    name: jenkins_internal
    internal: true
