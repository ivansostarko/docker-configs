version: "3.9"

services:
  postgres:
    image: postgres:16
    container_name: postgres
    hostname: postgres
    restart: unless-stopped

    networks:
      - asterix_network

    # If you must publish, bind to localhost (default). Change PG_ARCHIVE_DB_BIND if you truly need remote access.
    ports:
      - "${PG_ARCHIVE_DB_BIND:-127.0.0.1}:${PG_ARCHIVE_DB_PORT:-5432}:5432"

    env_file:
      - .env

    # Prefer secrets over plaintext env vars.
    environment:
      POSTGRES_DB: ${PG_ARCHIVE_DB_NAME}
      POSTGRES_USER: ${PG_ARCHIVE_DB_USER}
      POSTGRES_PASSWORD_FILE: /run/secrets/pg_archive_db_password

    secrets:
      - pg_archive_db_password

    volumes:
      - postgres_archive_data:/var/lib/postgresql/data
      # Optional init scripts (run only on first init of empty data dir)
      - ./config/postgres/initdb:/docker-entrypoint-initdb.d:ro

    configs:
      - source: postgres_conf
        target: /etc/postgresql/postgresql.conf
        mode: 0444
      - source: postgres_hba
        target: /etc/postgresql/pg_hba.conf
        mode: 0444

    command:
      - "postgres"
      - "-c"
      - "config_file=/etc/postgresql/postgresql.conf"
      - "-c"
      - "hba_file=/etc/postgresql/pg_hba.conf"

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${PG_ARCHIVE_DB_USER} -d ${PG_ARCHIVE_DB_NAME} -h 127.0.0.1 -p 5432 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 20s

    # Common operational knobs
    shm_size: "1g"
    ulimits:
      nofile:
        soft: 65536
        hard: 65536

    tmpfs:
      - /var/run/postgresql:rw,noexec,nosuid,size=64m
      - /tmp:rw,noexec,nosuid,size=256m

    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    init: true

    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

    stop_signal: SIGTERM
    stop_grace_period: 60s

    # Optional resource controls (docker-compose, not Swarm)
    mem_limit: 4g
    pids_limit: 4096

    labels:
      com.example.service: "postgres"
      com.example.role: "archive-db"

  postgres-exporter:
    image: prometheuscommunity/postgres-exporter:latest
    container_name: postgres-exporter
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy

    networks:
      - asterix_network

    # Expose metrics to Prometheus (usually internal only).
    ports:
      - "${POSTGRES_EXPORTER_PORT:-9187}:9187"

    env_file:
      - .env

    secrets:
      - pg_archive_db_password

    # Build DATA_SOURCE_NAME from secret at runtime (exporter doesn't reliably support *_FILE across builds).
    command:
      - /bin/sh
      - -ec
      - |
        export PGPASSWORD="$(cat /run/secrets/pg_archive_db_password)"
        export DATA_SOURCE_NAME="postgresql://${PG_ARCHIVE_DB_USER}:${PGPASSWORD}@postgres:5432/${PG_ARCHIVE_DB_NAME}?sslmode=disable"
        exec /bin/postgres_exporter

    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

networks:
  asterix_network:
    name: asterix_network
    driver: bridge

volumes:
  postgres_archive_data:
    name: postgres_archive_data

secrets:
  pg_archive_db_password:
    file: ./secrets/pg_archive_db_password.txt

configs:
  postgres_conf:
    file: ./config/postgres/postgresql.conf
  postgres_hba:
    file: ./config/postgres/pg_hba.conf
