# MinIO Docker Compose Bundle

This bundle provides a production-leaning MinIO setup with:
- Pinned image tags (no `latest`)
- Docker secrets for root credentials (no plaintext in `.env`)
- Optional TLS mount path
- A one-shot `minio-init` container for provisioning and metrics token generation
- Metrics wiring guidance for Prometheus

## Contents

```
minio/
  docker-compose.yml
  .env.example
  secrets/
    minio_root_user.txt
    minio_root_password.txt
  config/minio/
    policies/
      README.md
    generated/
      .gitkeep
  certs/minio/
    README.md
```

## Quick start

1. Copy environment file:

```bash
cd minio
cp .env.example .env
```

2. Create secrets (do not commit these):

```bash
mkdir -p secrets
echo "minio-root-user" > secrets/minio_root_user.txt
openssl rand -base64 48 > secrets/minio_root_password.txt
```

3. Start:

```bash
docker compose up -d
```

4. Verify:
- S3 API: `http://localhost:9000`
- Console: `http://localhost:9001`

## Provisioning (minio-init)

The `minio-init` service will:
- Wait for MinIO
- Create `MINIO_DEFAULT_BUCKET` (if set)
- If `MINIO_PROMETHEUS_AUTH_TYPE=jwt`, generate a Prometheus scrape snippet with bearer token:
  - `config/minio/generated/prometheus_minio_scrape.yml`

If you do not want this behavior, remove the `minio-init` service.

## Policies

Place policy JSON files in:

```
config/minio/policies/
```

Then uncomment/adapt the example line in `minio-init`:

```sh
# mc admin policy create local readonly /policies/readonly.json || true
```

## Metrics

MinIO exports Prometheus-format metrics on endpoints under:

- `/minio/v2/metrics/cluster`
- `/minio/v2/metrics/node`
- `/minio/v2/metrics/bucket`

Recommended: keep metrics auth as `jwt` and scrape with the bearer token generated by `mc admin prometheus generate`
(which this bundle writes into `config/minio/generated/prometheus_minio_scrape.yml`).

If you set `MINIO_PROMETHEUS_AUTH_TYPE=public`, scraping works without auth, but you are weakening security.

## TLS

If you want MinIO to serve TLS directly, place certs at:

```
certs/minio/public.crt
certs/minio/private.key
```

And ensure your `MINIO_SERVER_URL`/`MINIO_BROWSER_REDIRECT_URL` match your HTTPS endpoints.

Many deployments terminate TLS at a reverse proxy (Traefik/Nginx/Caddy) instead, and keep MinIO internal-only.

## Healthcheck

The included healthcheck uses `wget`. If your MinIO image does not contain `wget`, the healthcheck will fail even if MinIO is healthy.

Operationally cleaner options:
- Remove container healthcheck and use external probing (Prometheus blackbox / uptime checks)
- Build a tiny derived image that adds `curl` or `wget`

## Hardline recommendations (donâ€™t ignore)

- Do not run `latest`.
- Do not publish MinIO ports to the public internet.
- Use TLS.
- Rotate root credentials and create least-privileged users for applications.
