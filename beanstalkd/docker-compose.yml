version: "3.9"

x-logging: &default-logging
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "5"

x-common: &common
  restart: unless-stopped
  logging: *default-logging
  security_opt:
    - no-new-privileges:true

services:
  # =========================
  # Beanstalkd (core)
  # =========================
  beanstalkd:
    <<: *common
    image: schickling/beanstalkd:latest
    container_name: beanstalkd
    command:
      - /bin/sh
      - -ec
      - |
        args="-l ${BEANSTALKD_LISTEN_ADDR} -p ${BEANSTALKD_PORT} -z ${BEANSTALKD_MAX_JOB_SIZE}"
        if [ "${BEANSTALKD_ENABLE_BINLOG}" = "1" ]; then
          mkdir -p "${BEANSTALKD_BINLOG_DIR}"
          args="$args -b ${BEANSTALKD_BINLOG_DIR} -f ${BEANSTALKD_FSYNC_PERIOD_SECONDS}"
        fi
        exec beanstalkd $args
    environment:
      BEANSTALKD_LISTEN_ADDR: ${BEANSTALKD_LISTEN_ADDR:-0.0.0.0}
      BEANSTALKD_PORT: ${BEANSTALKD_PORT:-11300}
      BEANSTALKD_ENABLE_BINLOG: ${BEANSTALKD_ENABLE_BINLOG:-1}
      BEANSTALKD_BINLOG_DIR: ${BEANSTALKD_BINLOG_DIR:-/var/lib/beanstalkd/binlog}
      BEANSTALKD_FSYNC_PERIOD_SECONDS: ${BEANSTALKD_FSYNC_PERIOD_SECONDS:-1}
      BEANSTALKD_MAX_JOB_SIZE: ${BEANSTALKD_MAX_JOB_SIZE:-65535}
    volumes:
      - beanstalkd-binlog:/var/lib/beanstalkd
    ports:
      # Default is localhost-only publishing. Change BEANSTALKD_PUBLISH_ADDR if you insist.
      - "${BEANSTALKD_PUBLISH_ADDR:-127.0.0.1}:${BEANSTALKD_PUBLISH_PORT:-11300}:11300"
    networks:
      - app_net
      - monitoring_net
    healthcheck:
      # Avoid relying on nc/telnet availability; just verify process is present.
      test: ["CMD-SHELL", "ps | grep -q '[b]eanstalkd'"]
      interval: 10s
      timeout: 3s
      retries: 10
      start_period: 5s
    ulimits:
      nofile:
        soft: 65535
        hard: 65535

  # =========================
  # Optional: Web console (admin UI)
  # =========================
  beanstalkd_console:
    <<: *common
    image: schickling/beanstalkd-console:latest
    container_name: beanstalkd_console
    profiles: ["admin"]
    environment:
      # Keep it internal unless you add your own auth in front.
      BEANSTALK_SERVERS: "beanstalkd:11300"
    ports:
      - "${BEANSTALKD_CONSOLE_PUBLISH_ADDR:-127.0.0.1}:${BEANSTALKD_CONSOLE_PUBLISH_PORT:-2080}:80"
    depends_on:
      beanstalkd:
        condition: service_healthy
    networks:
      - app_net

  # =========================
  # Metrics: Beanstalkd exporter for Prometheus
  # =========================
  beanstalkd_exporter:
    <<: *common
    image: seitk/beanstalkd_exporter:latest
    container_name: beanstalkd_exporter
    profiles: ["monitoring"]
    environment:
      BEANSTALKD_ADDR: "beanstalkd:11300"
      BEANSTALKD_TUBES: "${BEANSTALKD_EXPORTER_TUBES:-default}"
    ports:
      - "${BEANSTALKD_EXPORTER_PUBLISH_ADDR:-127.0.0.1}:${BEANSTALKD_EXPORTER_PUBLISH_PORT:-8080}:8080"
    depends_on:
      beanstalkd:
        condition: service_healthy
    networks:
      - monitoring_net
      - app_net
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:8080/metrics >/dev/null 2>&1"]
      interval: 15s
      timeout: 5s
      retries: 10
      start_period: 10s

  # =========================
  # Optional: Prometheus
  # =========================
  prometheus:
    <<: *common
    image: prom/prometheus:latest
    container_name: prometheus
    profiles: ["monitoring"]
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--web.enable-lifecycle"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./monitoring/alert.rules.yml:/etc/prometheus/alert.rules.yml:ro
      - prometheus-data:/prometheus
    ports:
      - "${PROMETHEUS_PUBLISH_ADDR:-127.0.0.1}:${PROMETHEUS_PUBLISH_PORT:-9090}:9090"
    depends_on:
      beanstalkd_exporter:
        condition: service_healthy
    networks:
      - monitoring_net
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:9090/-/healthy >/dev/null 2>&1"]
      interval: 15s
      timeout: 5s
      retries: 10
      start_period: 10s

  # =========================
  # Optional: Grafana
  # =========================
  grafana:
    <<: *common
    image: grafana/grafana:latest
    container_name: grafana
    profiles: ["monitoring"]
    environment:
      GF_SECURITY_ADMIN_USER: "${GRAFANA_ADMIN_USER:-admin}"
      GF_SECURITY_ADMIN_PASSWORD__FILE: /run/secrets/grafana_admin_password
      GF_USERS_ALLOW_SIGN_UP: "false"
    secrets:
      - grafana_admin_password
    volumes:
      - grafana-data:/var/lib/grafana
      - ./grafana/provisioning/datasources/datasource.yml:/etc/grafana/provisioning/datasources/datasource.yml:ro
    ports:
      - "${GRAFANA_PUBLISH_ADDR:-127.0.0.1}:${GRAFANA_PUBLISH_PORT:-3000}:3000"
    depends_on:
      prometheus:
        condition: service_healthy
    networks:
      - monitoring_net
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:3000/api/health >/dev/null 2>&1"]
      interval: 15s
      timeout: 5s
      retries: 10
      start_period: 20s

networks:
  app_net:
    name: beanstalkd_app_net
    driver: bridge
    internal: true

  monitoring_net:
    name: beanstalkd_monitoring_net
    driver: bridge
    internal: true

volumes:
  beanstalkd-binlog:
    name: beanstalkd_binlog
  prometheus-data:
    name: beanstalkd_prometheus_data
  grafana-data:
    name: beanstalkd_grafana_data

secrets:
  grafana_admin_password:
    file: ./secrets/grafana_admin_password.txt
