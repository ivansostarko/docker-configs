# Passbolt (CE) production-oriented docker-compose.
# Notes:
# - Pin image tags in .env (do NOT leave "latest" in production).
# - Secrets are provided via Docker Compose "secrets" and Passbolt *_FILE env vars.
# - Monitoring stack is optional (profile: monitoring).

name: passbolt

x-logging: &default-logging
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"

networks:
  passbolt_internal:
    name: passbolt_internal
    driver: bridge
    internal: true
  passbolt_public:
    name: passbolt_public
    driver: bridge

volumes:
  mariadb_data:
    name: passbolt_mariadb_data
  passbolt_gpg:
    name: passbolt_gpg
  passbolt_jwt:
    name: passbolt_jwt
  prometheus_data:
    name: passbolt_prometheus_data
  grafana_data:
    name: passbolt_grafana_data

secrets:
  # Passbolt DB creds (supported by Passbolt via *_FILE variables)
  db_host:
    file: ./secrets/db_host.txt
  db_name:
    file: ./secrets/db_name.txt
  db_user:
    file: ./secrets/db_user.txt
  db_password:
    file: ./secrets/db_password.txt
  db_root_password:
    file: ./secrets/db_root_password.txt

  # SMTP creds (supported by Passbolt via *_FILE variables)
  smtp_user:
    file: ./secrets/smtp_user.txt
  smtp_password:
    file: ./secrets/smtp_password.txt

  # TLS + GPG keys (supported "secret files" in Passbolt)
  tls_cert:
    file: ./secrets/tls_cert.crt
  tls_key:
    file: ./secrets/tls_key.key
  gpg_public:
    file: ./secrets/serverkey.asc
  gpg_private:
    file: ./secrets/serverkey_private.asc

  # Optional: exporter creds (monitoring profile)
  mysql_exporter_password:
    file: ./secrets/mysql_exporter_password.txt

services:
  db:
    image: ${MARIADB_IMAGE}
    container_name: passbolt-db
    restart: unless-stopped
    networks:
      - passbolt_internal
    volumes:
      - mariadb_data:/var/lib/mysql
      - ./config/mariadb/init:/docker-entrypoint-initdb.d:ro
    environment:
      # Minimal DB bootstrap (values are *read* on first init only; changing later won't change existing DB).
      # Use *_FILE for secrets; Compose will mount them into /run/secrets/.
      MARIADB_DATABASE_FILE: /run/secrets/db_name
      MARIADB_USER_FILE: /run/secrets/db_user
      MARIADB_PASSWORD_FILE: /run/secrets/db_password
      MARIADB_ROOT_PASSWORD_FILE: /run/secrets/db_root_password

      # Optional: run mariadb-upgrade automatically when image updates.
      MARIADB_AUTO_UPGRADE: "1"

      TZ: ${TZ}

    secrets:
      - db_name
      - db_user
      - db_password
      - db_root_password
      - mysql_exporter_password
    healthcheck:
      # Official MariaDB image ships healthcheck.sh; this checks TCP connect + InnoDB init.
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 10s
      timeout: 5s
      retries: 6
      start_period: 20s
    logging: *default-logging
    deploy:
      resources:
        limits:
          memory: ${DB_MEM_LIMIT}
        reservations:
          memory: ${DB_MEM_RESERVATION}

  passbolt:
    image: ${PASSBOLT_IMAGE}
    container_name: passbolt
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
    networks:
      - passbolt_internal
      - passbolt_public
    ports:
      # Passbolt container includes a web server and can serve HTTPS itself.
      - "${PASSBOLT_HTTP_PORT}:80"
      - "${PASSBOLT_HTTPS_PORT}:443"
    volumes:
      # Persist crypto material (required)
      - passbolt_gpg:/etc/passbolt/gpg
      - passbolt_jwt:/etc/passbolt/jwt

      # Optional: override /etc/passbolt/passbolt.php (lowest operational priority vs env vars / UI)
      # - ./config/passbolt/passbolt.php:/etc/passbolt/passbolt.php:ro

    environment:
      TZ: ${TZ}

      # REQUIRED: set your canonical external URL (mitigates host-header injection and is required for links).
      APP_FULL_BASE_URL: ${APP_FULL_BASE_URL}

      # DB (use *_FILE; Passbolt will read from files mounted at /run/secrets)
      DATASOURCES_DEFAULT_HOST_FILE: /run/secrets/db_host
      DATASOURCES_DEFAULT_DATABASE_FILE: /run/secrets/db_name
      DATASOURCES_DEFAULT_USERNAME_FILE: /run/secrets/db_user
      DATASOURCES_DEFAULT_PASSWORD_FILE: /run/secrets/db_password

      # SMTP basics (configure fully; otherwise registration/recovery emails won't work).
      EMAIL_DEFAULT_FROM_NAME: ${EMAIL_DEFAULT_FROM_NAME}
      EMAIL_DEFAULT_FROM: ${EMAIL_DEFAULT_FROM}
      EMAIL_TRANSPORT_DEFAULT_HOST: ${EMAIL_TRANSPORT_DEFAULT_HOST}
      EMAIL_TRANSPORT_DEFAULT_PORT: ${EMAIL_TRANSPORT_DEFAULT_PORT}
      EMAIL_TRANSPORT_DEFAULT_TLS: ${EMAIL_TRANSPORT_DEFAULT_TLS}
      EMAIL_TRANSPORT_DEFAULT_USERNAME_FILE: /run/secrets/smtp_user
      EMAIL_TRANSPORT_DEFAULT_PASSWORD_FILE: /run/secrets/smtp_password

      # Optional hardening defaults
      PASSBOLT_PLUGINS_SELF_REGISTRATION_ENABLED: "false"

      # Optional: provide TLS cert/key as Docker secrets (Passbolt supports these files)
      PASSBOLT_SSL_SERVER_CERT_FILE: /run/secrets/tls_cert
      PASSBOLT_SSL_SERVER_KEY_FILE: /run/secrets/tls_key

      # Optional: provide GPG server keys as Docker secrets (Passbolt supports these files)
      PASSBOLT_GPG_SERVER_KEY_PUBLIC_FILE: /run/secrets/gpg_public
      PASSBOLT_GPG_SERVER_KEY_PRIVATE_FILE: /run/secrets/gpg_private

      # If you migrate an existing instance, you may need to set:
      # PASSBOLT_GPG_SERVER_KEY_FINGERPRINT: "YOUR_FINGERPRINT"
      # PASSBOLT_KEY_EMAIL: "passbolt@yourdomain.tld"

    secrets:
      - db_host
      - db_name
      - db_user
      - db_password
      - smtp_user
      - smtp_password
      - tls_cert
      - tls_key
      - gpg_public
      - gpg_private

    healthcheck:
      # Passbolt healthcheck must run as webserver user (www-data) on root images.
      # If you switch to the non-root image and healthcheck fails, replace with:
      # test: ["CMD-SHELL", "/usr/share/php/passbolt/bin/cake passbolt healthcheck >/dev/null 2>&1 || exit 1"]
      test: ["CMD-SHELL", "su -s /bin/sh -c '/usr/share/php/passbolt/bin/cake passbolt healthcheck' www-data >/dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 20s
      retries: 3
      start_period: 60s

    logging: *default-logging
    deploy:
      resources:
        limits:
          memory: ${PASSBOLT_MEM_LIMIT}
        reservations:
          memory: ${PASSBOLT_MEM_RESERVATION}

  # -------------------------
  # OPTIONAL MONITORING STACK
  # -------------------------

  cadvisor:
    image: gcr.io/cadvisor/cadvisor:latest
    container_name: passbolt-cadvisor
    profiles: ["monitoring"]
    restart: unless-stopped
    networks:
      - passbolt_public
    ports:
      - "${CADVISOR_PORT}:8080"
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:rw
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
    logging: *default-logging

  mysqld_exporter:
    image: prom/mysqld-exporter:latest
    container_name: passbolt-mysqld-exporter
    profiles: ["monitoring"]
    restart: unless-stopped
    networks:
      - passbolt_internal
      - passbolt_public
    depends_on:
      db:
        condition: service_healthy
    volumes:
      - ./config/mariadb/exporter/.my.cnf:/etc/.my.cnf:ro
    command:
      - --config.my-cnf=/etc/.my.cnf
    ports:
      - "${MYSQL_EXPORTER_PORT}:9104"
    logging: *default-logging

  prometheus:
    image: prom/prometheus:latest
    container_name: passbolt-prometheus
    profiles: ["monitoring"]
    restart: unless-stopped
    networks:
      - passbolt_public
      - passbolt_internal
    ports:
      - "${PROMETHEUS_PORT}:9090"
    volumes:
      - ./config/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    logging: *default-logging

  grafana:
    image: grafana/grafana:latest
    container_name: passbolt-grafana
    profiles: ["monitoring"]
    restart: unless-stopped
    networks:
      - passbolt_public
    ports:
      - "${GRAFANA_PORT}:3000"
    environment:
      - TZ=${TZ}
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD}
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - grafana_data:/var/lib/grafana
      - ./config/grafana/provisioning:/etc/grafana/provisioning:ro
    logging: *default-logging
