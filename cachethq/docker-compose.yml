version: "3.9"

x-logging: &default-logging
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"

services:
  # ------------------------
  # Cachet (status page)
  # ------------------------
  cachet:
    image: cachethq/docker:2.3.18 # pin a known release; do NOT use :latest in prod
    hostname: cachet
    restart: unless-stopped
    init: true

    depends_on:
      cachet-db:
        condition: service_healthy

    env_file:
      - .env

    environment:
      # App
      APP_ENV: ${CACHET_APP_ENV:-production}
      APP_DEBUG: ${CACHET_APP_DEBUG:-false}
      APP_URL: ${CACHET_APP_URL:?set-in-.env}
      APP_KEY: ${CACHET_APP_KEY:?set-in-.env}   # must be "base64:..."
      APP_TIMEZONE: ${CACHET_APP_TIMEZONE:-Europe/Zagreb}
      APP_LOCALE: ${CACHET_APP_LOCALE:-en}

      # DB (Cachet reads env vars; it does NOT natively read Docker secrets files)
      DB_DRIVER: ${CACHET_DB_DRIVER:-mysql}
      DB_HOST: cachet-db
      DB_PORT: ${CACHET_DB_PORT:-3306}
      DB_DATABASE: ${CACHET_DB_DATABASE:?set-in-.env}
      DB_USERNAME: ${CACHET_DB_USERNAME:?set-in-.env}
      DB_PASSWORD: ${CACHET_DB_PASSWORD:?set-in-.env}
      DB_PREFIX: ${CACHET_DB_PREFIX:-}

      # Cache/session/queue
      CACHE_DRIVER: ${CACHET_CACHE_DRIVER:-file}
      SESSION_DRIVER: ${CACHET_SESSION_DRIVER:-file}
      QUEUE_DRIVER: ${CACHET_QUEUE_DRIVER:-sync}

      # Mail (optional; keep if you use notifications/subscribers)
      MAIL_DRIVER: ${CACHET_MAIL_DRIVER:-smtp}
      MAIL_HOST: ${CACHET_MAIL_HOST:-}
      MAIL_PORT: ${CACHET_MAIL_PORT:-587}
      MAIL_USERNAME: ${CACHET_MAIL_USERNAME:-}
      MAIL_PASSWORD: ${CACHET_MAIL_PASSWORD:-}
      MAIL_ADDRESS: ${CACHET_MAIL_ADDRESS:-}
      MAIL_NAME: ${CACHET_MAIL_NAME:-}

    ports:
      - "${CACHET_PORT:-8000}:8000"

    volumes:
      # Persist runtime state that Cachet writes inside the container
      - cachet_storage:/var/www/html/storage
      - cachet_bootstrap_cache:/var/www/html/bootstrap/cache

    tmpfs:
      - /tmp

    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL

    healthcheck:
      # Cachet exposes a ping endpoint (commonly returns "pong")
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:8000/api/v1/ping | grep -qi pong"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 60s

    networks:
      - asterix_network

    logging: *default-logging


  # ------------------------
  # MariaDB for Cachet
  # ------------------------
  cachet-db:
    image: mariadb:10.11
    hostname: cachet-db
    restart: unless-stopped

    # Basic hardening and predictable DB behavior
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --skip-name-resolve

    env_file:
      - .env

    environment:
      MYSQL_DATABASE: ${CACHET_DB_DATABASE:?set-in-.env}
      MYSQL_USER: ${CACHET_DB_USERNAME:?set-in-.env}

      # Use secrets for DB passwords (MariaDB supports *_FILE)
      MYSQL_PASSWORD_FILE: /run/secrets/cachet_db_password
      MYSQL_ROOT_PASSWORD_FILE: /run/secrets/cachet_db_root_password

    secrets:
      - cachet_db_password
      - cachet_db_root_password

    volumes:
      - cachet_db_data:/var/lib/mysql
      # Optional: custom MariaDB tuning
      - ./config/cachet-db/z-cachet.cnf:/etc/mysql/conf.d/z-cachet.cnf:ro
      # Optional: init scripts (e.g., metrics user)
      - ./config/cachet-db/initdb:/docker-entrypoint-initdb.d:ro

    healthcheck:
      test:
        [
          "CMD-SHELL",
          "mysqladmin ping -h 127.0.0.1 -u root -p\"$$(cat /run/secrets/cachet_db_root_password)\" --silent"
        ]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

    networks:
      - asterix_network

    logging: *default-logging


  # ------------------------
  # Metrics (optional): MariaDB Prometheus exporter
  # ------------------------
  cachet-db-exporter:
    image: prom/mysqld-exporter:v0.18.0
    profiles: ["metrics"]
    restart: unless-stopped
    depends_on:
      cachet-db:
        condition: service_healthy

    command:
      - --web.listen-address=:9104
      - --config.my-cnf=/run/secrets/mysqld_exporter_my_cnf
      - --mysqld.address=cachet-db:3306

    secrets:
      - mysqld_exporter_my_cnf

    ports:
      # expose only if Prometheus is outside the docker network; otherwise omit
      - "${CACHET_DB_EXPORTER_PORT:-9104}:9104"

    networks:
      - asterix_network

    logging: *default-logging


networks:
  asterix_network:
    # If you already created and reuse this across your stack, keep external:true.
    external: true
    name: asterix_network


volumes:
  cachet_storage:
  cachet_bootstrap_cache:
  cachet_db_data:


secrets:
  # Docker Compose secrets are file-based. Create these files locally.
  cachet_db_password:
    file: ./secrets/cachet_db_password.txt
  cachet_db_root_password:
    file: ./secrets/cachet_db_root_password.txt

  # my.cnf for exporter (recommended: dedicated "exporter" DB user)
  mysqld_exporter_my_cnf:
    file: ./secrets/mysqld_exporter_my.cnf
