version: "3.9"

name: ${COMPOSE_PROJECT_NAME:-kafka-akhq}

networks:
  edge:
    driver: bridge
  kafka:
    driver: bridge
    internal: true
  monitoring:
    driver: bridge
    internal: true

volumes:
  kafka1_data:
  kafka2_data:
  kafka3_data:
  prometheus_data:
  grafana_data:
  jmx_exporter_jar:

secrets:
  grafana_admin_password:
    file: ./secrets/grafana_admin_password.txt
  # NOTE: Docker secrets cannot be injected into env vars automatically.
  # Keep this secret file for future use (e.g., custom entrypoint),
  # or copy its contents into AKHQ_JWT_SECRET in your .env file.
  akhq_jwt_secret:
    file: ./secrets/akhq_jwt_secret.txt

services:
  # Seed a shared volume with the JMX exporter javaagent jar so Kafka can load it.
  jmx-exporter-setup:
    image: bitnami/jmx-exporter:latest
    container_name: ${COMPOSE_PROJECT_NAME:-kafka-akhq}-jmx-exporter-setup
    networks: [monitoring]
    volumes:
      - jmx_exporter_jar:/jmx
    command: >
      bash -ec "
        cp /opt/bitnami/jmx-exporter/jmx_prometheus_javaagent.jar /jmx/;
        ls -l /jmx/;
      "
    restart: "no"

  kafka1:
    image: bitnamilegacy/kafka:4.0.0-debian-12-r10
    container_name: ${COMPOSE_PROJECT_NAME:-kafka-akhq}-kafka1
    networks: [kafka, monitoring]
    volumes:
      - kafka1_data:/bitnami/kafka
      - jmx_exporter_jar:/opt/jmx:ro
      - ./config/jmx-exporter/kafka-broker.yml:/opt/jmx/kafka-broker.yml:ro
    environment:
      TZ: ${TZ:-Europe/Zagreb}

      # KRaft
      KAFKA_CFG_NODE_ID: "1"
      KAFKA_CFG_PROCESS_ROLES: "controller,broker"
      KAFKA_CFG_CONTROLLER_LISTENER_NAMES: "CONTROLLER"
      KAFKA_CFG_CONTROLLER_QUORUM_VOTERS: "1@kafka1:9093,2@kafka2:9093,3@kafka3:9093"
      KAFKA_KRAFT_CLUSTER_ID: ${KAFKA_KRAFT_CLUSTER_ID}

      # Listeners
      KAFKA_CFG_LISTENERS: "PLAINTEXT://:9092,CONTROLLER://:9093"
      KAFKA_CFG_ADVERTISED_LISTENERS: "PLAINTEXT://kafka1:9092"
      KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP: "PLAINTEXT:PLAINTEXT,CONTROLLER:PLAINTEXT"
      KAFKA_CFG_INTER_BROKER_LISTENER_NAME: "PLAINTEXT"

      # Dev/lab only. For anything beyond local/dev, switch to SASL_SSL/mTLS.
      ALLOW_PLAINTEXT_LISTENER: "yes"

      # JMX exporter javaagent (Prometheus scrape at :7071)
      KAFKA_OPTS: "-javaagent:/opt/jmx/jmx_prometheus_javaagent.jar=7071:/opt/jmx/kafka-broker.yml"

    depends_on:
      jmx-exporter-setup:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD-SHELL", "kafka-broker-api-versions.sh --bootstrap-server localhost:9092 >/dev/null 2>&1"]
      interval: 15s
      timeout: 5s
      retries: 20
      start_period: 30s
    restart: unless-stopped

  kafka2:
    image: bitnamilegacy/kafka:4.0.0-debian-12-r10
    container_name: ${COMPOSE_PROJECT_NAME:-kafka-akhq}-kafka2
    networks: [kafka, monitoring]
    volumes:
      - kafka2_data:/bitnami/kafka
      - jmx_exporter_jar:/opt/jmx:ro
      - ./config/jmx-exporter/kafka-broker.yml:/opt/jmx/kafka-broker.yml:ro
    environment:
      TZ: ${TZ:-Europe/Zagreb}

      KAFKA_CFG_NODE_ID: "2"
      KAFKA_CFG_PROCESS_ROLES: "controller,broker"
      KAFKA_CFG_CONTROLLER_LISTENER_NAMES: "CONTROLLER"
      KAFKA_CFG_CONTROLLER_QUORUM_VOTERS: "1@kafka1:9093,2@kafka2:9093,3@kafka3:9093"
      KAFKA_KRAFT_CLUSTER_ID: ${KAFKA_KRAFT_CLUSTER_ID}

      KAFKA_CFG_LISTENERS: "PLAINTEXT://:9092,CONTROLLER://:9093"
      KAFKA_CFG_ADVERTISED_LISTENERS: "PLAINTEXT://kafka2:9092"
      KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP: "PLAINTEXT:PLAINTEXT,CONTROLLER:PLAINTEXT"
      KAFKA_CFG_INTER_BROKER_LISTENER_NAME: "PLAINTEXT"
      ALLOW_PLAINTEXT_LISTENER: "yes"

      KAFKA_OPTS: "-javaagent:/opt/jmx/jmx_prometheus_javaagent.jar=7072:/opt/jmx/kafka-broker.yml"

    depends_on:
      kafka1:
        condition: service_healthy
      jmx-exporter-setup:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD-SHELL", "kafka-broker-api-versions.sh --bootstrap-server localhost:9092 >/dev/null 2>&1"]
      interval: 15s
      timeout: 5s
      retries: 20
      start_period: 30s
    restart: unless-stopped

  kafka3:
    image: bitnamilegacy/kafka:4.0.0-debian-12-r10
    container_name: ${COMPOSE_PROJECT_NAME:-kafka-akhq}-kafka3
    networks: [kafka, monitoring]
    volumes:
      - kafka3_data:/bitnami/kafka
      - jmx_exporter_jar:/opt/jmx:ro
      - ./config/jmx-exporter/kafka-broker.yml:/opt/jmx/kafka-broker.yml:ro
    environment:
      TZ: ${TZ:-Europe/Zagreb}

      KAFKA_CFG_NODE_ID: "3"
      KAFKA_CFG_PROCESS_ROLES: "controller,broker"
      KAFKA_CFG_CONTROLLER_LISTENER_NAMES: "CONTROLLER"
      KAFKA_CFG_CONTROLLER_QUORUM_VOTERS: "1@kafka1:9093,2@kafka2:9093,3@kafka3:9093"
      KAFKA_KRAFT_CLUSTER_ID: ${KAFKA_KRAFT_CLUSTER_ID}

      KAFKA_CFG_LISTENERS: "PLAINTEXT://:9092,CONTROLLER://:9093"
      KAFKA_CFG_ADVERTISED_LISTENERS: "PLAINTEXT://kafka3:9092"
      KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP: "PLAINTEXT:PLAINTEXT,CONTROLLER:PLAINTEXT"
      KAFKA_CFG_INTER_BROKER_LISTENER_NAME: "PLAINTEXT"
      ALLOW_PLAINTEXT_LISTENER: "yes"

      KAFKA_OPTS: "-javaagent:/opt/jmx/jmx_prometheus_javaagent.jar=7073:/opt/jmx/kafka-broker.yml"

    depends_on:
      kafka2:
        condition: service_healthy
      jmx-exporter-setup:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD-SHELL", "kafka-broker-api-versions.sh --bootstrap-server localhost:9092 >/dev/null 2>&1"]
      interval: 15s
      timeout: 5s
      retries: 20
      start_period: 30s
    restart: unless-stopped

  # AKHQ (Kafka Admin GUI)
  akhq:
    image: tchiotludo/akhq:latest
    container_name: ${COMPOSE_PROJECT_NAME:-kafka-akhq}-akhq
    networks: [edge, kafka, monitoring]
    ports:
      - "${AKHQ_HTTP_PORT:-8080}:8080"
    volumes:
      - ./config/akhq/application.yml:/app/application.yml:ro
    environment:
      TZ: ${TZ:-Europe/Zagreb}

      AKHQ_ADMIN_USER: ${AKHQ_ADMIN_USER:-admin}
      AKHQ_ADMIN_PASSWORD_SHA256: ${AKHQ_ADMIN_PASSWORD_SHA256}

      AKHQ_READER_USER: ${AKHQ_READER_USER:-reader}
      AKHQ_READER_PASSWORD_SHA256: ${AKHQ_READER_PASSWORD_SHA256}

      # Used in application.yml (Micronaut JWT signing secret).
      # Option A (recommended for pure dev): put the value directly in .env
      # Option B: keep ./secrets/akhq_jwt_secret.txt and wire it via a custom entrypoint.
      AKHQ_JWT_SECRET: ${AKHQ_JWT_SECRET:-change-me}

    # Secret is present but not automatically read into env; see README.
    secrets:
      - akhq_jwt_secret

    depends_on:
      kafka1:
        condition: service_healthy
      kafka2:
        condition: service_healthy
      kafka3:
        condition: service_healthy

    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:28081/health | grep -q UP"]
      interval: 15s
      timeout: 5s
      retries: 20
      start_period: 30s
    restart: unless-stopped

  # Kafka Exporter (consumer group lag + broker/topic metrics via Kafka protocol)
  kafka-exporter:
    image: bitnami/kafka-exporter:latest
    container_name: ${COMPOSE_PROJECT_NAME:-kafka-akhq}-kafka-exporter
    networks: [monitoring, kafka]
    environment:
      KAFKA_SERVER: "kafka1:9092,kafka2:9092,kafka3:9092"
    depends_on:
      kafka1:
        condition: service_healthy
      kafka2:
        condition: service_healthy
      kafka3:
        condition: service_healthy
    restart: unless-stopped

  prometheus:
    image: prom/prometheus:latest
    container_name: ${COMPOSE_PROJECT_NAME:-kafka-akhq}-prometheus
    networks: [edge, monitoring]
    ports:
      - "${PROMETHEUS_PORT:-9090}:9090"
    volumes:
      - ./config/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:9090/-/healthy | grep -q Healthy"]
      interval: 15s
      timeout: 5s
      retries: 20
      start_period: 20s
    restart: unless-stopped

  grafana:
    image: grafana/grafana:latest
    container_name: ${COMPOSE_PROJECT_NAME:-kafka-akhq}-grafana
    networks: [edge, monitoring]
    ports:
      - "${GRAFANA_PORT:-3000}:3000"
    volumes:
      - grafana_data:/var/lib/grafana
      - ./config/grafana/provisioning:/etc/grafana/provisioning:ro
    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_ADMIN_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD__FILE: /run/secrets/grafana_admin_password
      GF_USERS_ALLOW_SIGN_UP: "false"
    secrets:
      - grafana_admin_password
    depends_on:
      prometheus:
        condition: service_healthy
    restart: unless-stopped
