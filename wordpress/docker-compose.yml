name: store

x-logging: &default-logging
  driver: json-file
  options:
    max-size: "10m"
    max-file: "3"

x-common: &common
  restart: unless-stopped
  init: true
  networks:
    - asterix_network
  logging: *default-logging
  security_opt:
    - no-new-privileges:true

services:
  # ------------------------
  # WordPress
  # ------------------------
  wordpress:
    <<: *common
    image: wordpress:6.6.2-php8.2-apache
    container_name: store-wordpress
    hostname: store-wordpress
    depends_on:
      wordpress-db:
        condition: service_healthy
    ports:
      - "${WORDPRESS_PORT:-8080}:80"
    env_file:
      - .env
    environment:
      WORDPRESS_DB_HOST: wordpress-db:3306
      WORDPRESS_DB_USER: ${WORDPRESS_DB_USER}
      WORDPRESS_DB_NAME: ${WORDPRESS_DB_NAME}

    # Load DB password from a Docker secret (avoid plaintext in .env)
    entrypoint: >
      bash -lc '
        export WORDPRESS_DB_PASSWORD="$(cat /run/secrets/wordpress_db_password)";
        exec docker-entrypoint.sh apache2-foreground
      '
    secrets:
      - wordpress_db_password

    volumes:
      - wordpress_data:/var/www/html

    configs:
      - source: wordpress_php_ini
        target: /usr/local/etc/php/conf.d/zz-custom.ini

    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost/wp-login.php >/dev/null || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 60s

  # ------------------------
  # MySQL 8 (WordPress DB)
  # ------------------------
  wordpress-db:
    <<: *common
    image: mysql:8.0.39
    container_name: wordpress-mysql
    hostname: wordpress-db
    env_file:
      - .env
    environment:
      MYSQL_DATABASE: ${WORDPRESS_DB_NAME}
      MYSQL_USER: ${WORDPRESS_DB_USER}
      MYSQL_PASSWORD_FILE: /run/secrets/wordpress_db_password
      MYSQL_ROOT_PASSWORD_FILE: /run/secrets/mysql_root_password
      MYSQL_INITDB_SKIP_TZINFO: "1"

    secrets:
      - wordpress_db_password
      - mysql_root_password

    volumes:
      - wordpress_db_data:/var/lib/mysql
      # - ./config/mysql/init:/docker-entrypoint-initdb.d:ro

    configs:
      - source: mysql_custom_cnf
        target: /etc/mysql/conf.d/zz-custom.cnf

    # If you need host access, bind to localhost only:
    # ports:
    #   - "127.0.0.1:3306:3306"

    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h 127.0.0.1 -uroot -p"$$(cat /run/secrets/mysql_root_password)" --silent"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

networks:
  asterix_network:
    name: asterix_network
    driver: bridge
    # external: true

volumes:
  wordpress_data:
    name: store_wordpress_data
  wordpress_db_data:
    name: store_wordpress_db_data

configs:
  wordpress_php_ini:
    file: ./config/wordpress/php.ini
  mysql_custom_cnf:
    file: ./config/mysql/my.cnf

secrets:
  wordpress_db_password:
    file: ./secrets/wordpress_db_password.txt
  mysql_root_password:
    file: ./secrets/mysql_root_password.txt
