version: "3.9"

services:
  coturn:
    image: coturn/coturn:latest
    container_name: coturn
    hostname: coturn
    restart: unless-stopped

    env_file:
      - .env

    environment:
      TURN_REALM: "${TURN_REALM}"
      TURN_EXTERNAL_IP: "${TURN_EXTERNAL_IP}"

    ports:
      - "${COTURN_PORT}:3478/udp"
      - "${COTURN_PORT}:3478/tcp"
      - "${COTURN_PORT_SSL}:5349/tcp"
      - "${COTURN_RELAY_PORT_RANGE}:${COTURN_RELAY_PORT_RANGE}/udp"

    networks:
      - asterix_network

    configs:
      - source: coturn_turnserver_conf
        target: /etc/coturn/turnserver.conf
        mode: 0444

    secrets:
      - source: coturn_fullchain_pem
        target: /run/secrets/coturn_fullchain.pem
        mode: 0444
      - source: coturn_privkey_pem
        target: /run/secrets/coturn_privkey.pem
        mode: 0400

    volumes:
      - coturn_logs:/var/log/coturn

    command: ["turnserver", "-c", "/etc/coturn/turnserver.conf", "--no-cli"]

    healthcheck:
      test: ["CMD-SHELL", "pgrep -x turnserver >/dev/null 2>&1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 20s

    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp
      - /run

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    ulimits:
      nofile:
        soft: 65536
        hard: 65536

  # Optional metrics sidecar (example only â€” choose an exporter you actually trust)
  # coturn_exporter:
  #   image: <YOUR_COTURN_EXPORTER_IMAGE>
  #   container_name: coturn-exporter
  #   restart: unless-stopped
  #   depends_on:
  #     coturn:
  #       condition: service_healthy
  #   networks:
  #     - asterix_network
  #   ports:
  #     - "${COTURN_METRICS_PORT}:<EXPORTER_PORT>"
  #   environment:
  #     - TURN_HOST=coturn
  #     - TURN_PORT=3478

networks:
  asterix_network:
    name: asterix_network
    driver: bridge
    # ipam:
    #   config:
    #     - subnet: 172.30.0.0/16

volumes:
  coturn_logs:
    name: coturn_logs

configs:
  coturn_turnserver_conf:
    file: ./config/coturn/turnserver.conf

secrets:
  coturn_fullchain_pem:
    file: ./config/coturn/certs/fullchain.pem
  coturn_privkey_pem:
    file: ./config/coturn/certs/privkey.pem
